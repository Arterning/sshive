name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string
      build_linux:
        description: 'æ˜¯å¦åŒæ—¶æ‰“åŒ… Linux'
        required: false
        type: boolean
        default: false
      build_macos:
        description: 'æ˜¯å¦åŒæ—¶æ‰“åŒ… macOS'
        required: false
        type: boolean
        default: false

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: å®‰è£…ä¾èµ–
        run: |
          uv sync

      - name: æ‰“åŒ…åº”ç”¨
        run: |
          uv run pyinstaller build.spec --clean

      - name: é‡å‘½åæ–‡ä»¶
        run: |
          mv dist/SSHive.exe dist/SSHive-${{ inputs.version }}-windows.exe

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/SSHive-${{ inputs.version }}-windows.exe

  build-linux:
    if: ${{ inputs.build_linux }}
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0

      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: å®‰è£…ä¾èµ–
        run: |
          uv sync

      - name: æ‰“åŒ…åº”ç”¨
        run: |
          uv run pyinstaller build.spec --clean

      - name: é‡å‘½åæ–‡ä»¶
        run: |
          mv dist/SSHive dist/SSHive-${{ inputs.version }}-linux

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: dist/SSHive-${{ inputs.version }}-linux

  build-macos:
    if: ${{ inputs.build_macos }}
    runs-on: macos-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: å®‰è£…ä¾èµ–
        run: |
          uv sync

      - name: æ‰“åŒ…åº”ç”¨
        run: |
          uv run pyinstaller build.spec --clean

      - name: é‡å‘½åæ–‡ä»¶
        run: |
          mv dist/SSHive dist/SSHive-${{ inputs.version }}-macos

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: dist/SSHive-${{ inputs.version }}-macos

  create-release:
    needs: [build-windows, build-linux, build-macos]
    if: always() && needs.build-windows.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version }}
          name: Release ${{ inputs.version }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/*
          body: |
            ## SSHive ${{ inputs.version }}

            ### ä¸‹è½½è¯´æ˜
            - **Windows ç”¨æˆ·**: ä¸‹è½½ `SSHive-${{ inputs.version }}-windows.exe`
            - **Linux ç”¨æˆ·**: ä¸‹è½½ `SSHive-${{ inputs.version }}-linux` (éœ€æ·»åŠ æ‰§è¡Œæƒé™: `chmod +x SSHive-${{ inputs.version }}-linux`)
            - **macOS ç”¨æˆ·**: ä¸‹è½½ `SSHive-${{ inputs.version }}-macos` (éœ€æ·»åŠ æ‰§è¡Œæƒé™: `chmod +x SSHive-${{ inputs.version }}-macos`)

            ### æ›´æ–°å†…å®¹
            <!-- è¯·åœ¨è¿™é‡Œæ‰‹åŠ¨æ·»åŠ æ›´æ–°å†…å®¹ -->

            ---
            ğŸ¤– æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨æ„å»ºç”Ÿæˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
